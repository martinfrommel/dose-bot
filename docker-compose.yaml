services:
  dosebot:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        COPY_SCRIPTS: ${COPY_SCRIPTS:-0}
        SCRIPT_EXCLUDES: ${SCRIPT_EXCLUDES:-"buildImage.ts"}
        DEMO_MODE: ${DEMO_MODE:-0}
    container_name: dosebot
    expose:
      - "8910"  # Web port
      - "8911"  # Healthcheck port
    volumes:
      # Persist SQLite database
      - ./data:/app/data
    environment:
      # Coolify: route everything to the web port (8910); web server proxies /.redwood/functions to API
      SERVICE_URL_DOSEBOT_8910: "${SERVICE_URL_DOSEBOT_8910:-}"
      SESSION_SECRET: "${SERVICE_PASSWORD_64_DOSEBOT}"
      NODE_ENV: production
      DATABASE_URL: file:/app/data/dosebot.db
      ADMIN_EMAIL: "${ADMIN_EMAIL:-}"
      RUN_SEED: ${RUN_SEED:-0}
      COPY_SCRIPTS: ${COPY_SCRIPTS:-0}
      SCRIPT_EXCLUDES: "${SCRIPT_EXCLUDES:-buildImage.ts dockerUtils.ts lib/}"
      DEMO_MODE: ${DEMO_MODE:-0}
      ANALYTICS_ENABLED: "${ANALYTICS_ENABLED:-1}"
      ANALYTICS_ENDPOINT: "${ANALYTICS_ENDPOINT:-}"
      ANALYTICS_WEBSITE_ID: "${ANALYTICS_WEBSITE_ID:-}"
      ANALYTICS_SCRIPT_URL: "${ANALYTICS_SCRIPT_URL:-}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dosebot-api.rule=HostRegexp(`{host:.+}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.dosebot-api.entrypoints=https"
      - "traefik.http.routers.dosebot-api.tls=true"
      - "traefik.http.routers.dosebot-api.service=dosebot-api"
      - "traefik.http.services.dosebot-api.loadbalancer.server.port=8911"
      - "traefik.http.middlewares.dosebot-api-rewrite.replacepathregex.regex=^/api/?(.*)"
      - "traefik.http.middlewares.dosebot-api-rewrite.replacepathregex.replacement=/.redwood/functions/$1"
      - "traefik.http.routers.dosebot-api.middlewares=dosebot-api-rewrite"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -X GET http://localhost:8911/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - coolify

networks:
  coolify:
    external: true
